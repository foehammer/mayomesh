<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, minimum-scale=1.0, shrink-to-fit=no, viewport-fit=cover">

  <!-- Replace with your own title and description. -->
  <title>Mayo Mesh</title>
  <meta name="description" content="A site for information on mesh radio network's in Mayo, Ireland.">

  <!-- Default Theme (see https://docsify.js.org/#/themes) -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <!-- Mesh Data Widget -->
<link rel="stylesheet" href="meshtastic-widget.css">
</head>

<body>

  <div id="app"></div>

  <script>
    // === Docsify Configuration ===
    window.$docsify = {
      name: 'Mayo Mesh',
      image: 'mayo-mesh-colour-200.png',

      // Sidebar
      auto2top: true,
      loadSidebar: true,
      maxLevel: 0,
      subMaxLevel: 3,

      // Search
      search: {
        placeholder: 'Type to search',
        noData: 'No matches found.',
        depth: 2,
      },

      // Plugin: mount Meshtastic widgets after each render
      plugins: [
        function (hook, vm) {
          var instances = {};

          function toInt(val, def) {
            var n = parseInt(val, 10);
            return isNaN(n) ? def : n;
          }

          function cleanup() {
            // Destroy instances whose elements are no longer in the DOM
            Object.keys(instances).forEach(function (id) {
              var el = document.getElementById(id);
              if (!el || !document.body.contains(el)) {
                try { instances[id].destroy && instances[id].destroy(); } catch (e) { /* ignore */ }
                delete instances[id];
              }
            });
          }

          function getCtor() {
            // Handle both: bare class and window-attached
            try {
              if (typeof MeshtasticWidget === 'function') return MeshtasticWidget;
            } catch (e) { /* ReferenceError if not declared yet */ }
            if (typeof window.MeshtasticWidget === 'function') return window.MeshtasticWidget;
            return null;
          }

          function mount() {
            cleanup();
            var Ctor = getCtor();
            if (!Ctor) return false; // not ready yet

            var nodes = document.querySelectorAll('[data-meshtastic-worker]');
            nodes.forEach(function (el) {
              if (el.dataset.meshtasticMounted === '1') return;

              if (!el.id) {
                el.id = 'meshtastic-' + Math.random().toString(36).slice(2);
              }

              var workerUrl = el.getAttribute('data-meshtastic-worker');
              var opts = {};

              if (el.hasAttribute('data-refresh-interval')) {
                opts.refreshInterval = toInt(el.getAttribute('data-refresh-interval'), 60);
              }
              if (el.hasAttribute('data-time-range')) {
                opts.defaultTimeRange = toInt(el.getAttribute('data-time-range'), 24);
              }
              if (el.hasAttribute('data-title')) {
                opts.title = el.getAttribute('data-title');
              }
              if (el.hasAttribute('data-max-nodes')) {
                opts.maxNodes = toInt(el.getAttribute('data-max-nodes'), 20);
              }
              if (el.hasAttribute('data-show-controls')) {
                opts.showControls = el.getAttribute('data-show-controls') !== 'false';
              }
              if (el.hasAttribute('data-auto-refresh')) {
                opts.autoRefresh = el.getAttribute('data-auto-refresh') !== 'false';
              }

              try {
                instances[el.id] = new Ctor(el.id, workerUrl, opts);
                el.dataset.meshtasticMounted = '1';
              } catch (e) {
                console.error('Meshtastic init failed for', el, e);
              }
            });

            return true;
          }

          function mountWithRetry() {
            // Try a few times in case the class script hasnâ€™t executed yet
            var attempts = 0, max = 20; // ~2s
            var t = setInterval(function () {
              attempts++;
              if (mount() || attempts >= max) clearInterval(t);
            }, 100);
          }

          hook.mounted(function () {
            setTimeout(mountWithRetry, 0);
          });

          hook.doneEach(function () {
            setTimeout(mountWithRetry, 0);
          });
        }
      ]
    };
  </script>

  <!-- Required -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>

  <!-- Recommended -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/zoom-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.js"></script>
  <!-- Mesh Data -->
  <script src="meshtastic-widget.js"></script>
</body>
</html>
