<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, minimum-scale=1.0, shrink-to-fit=no, viewport-fit=cover">

  <title>Mayo Mesh</title>
  <meta name="description" content="A site for information on mesh radio network's in Mayo, Ireland.">

  <!-- Docsify Theme -->
  https://cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css

  <!-- Mesh Data Widget CSS -->
  ./meshtastic-widget.css
</head>

<body>
  <div id="app"></div>

  <script>
    // Docsify Configuration
    window.$docsify = {
      name: 'Mayo Mesh',
      image: 'mayo-mesh-colour-200.png',

      // Sidebar Configuration
      auto2top: true,
      loadSidebar: true,
      maxLevel: 0,
      subMaxLevel: 3,

      // Search Plugin
      search: {
        placeholder: 'Type to search',
        noData: 'No matches found.',
        depth: 2,
      },

      // Plugin: instantiate MeshtasticWidget after each Docsify render
      plugins: [
        function (hook, vm) {
          var instances = {};

          function toInt(val, def) {
            var n = parseInt(val, 10);
            return isNaN(n) ? def : n;
          }

          function cleanupStaleInstances() {
            Object.keys(instances).forEach(function (id) {
              var el = document.getElementById(id);
              if (!el || !document.body.contains(el)) {
                try { instances[id].destroy && instances[id].destroy(); } catch (e) {}
                delete instances[id];
              }
            });
          }

          function findCtor() {
            // Handle both global binding styles:
            //   class MeshtasticWidget {}  -> accessible as "MeshtasticWidget" (not on window)
            //   window.MeshtasticWidget = MeshtasticWidget; -> accessible on window
            if (typeof MeshtasticWidget === 'function') return MeshtasticWidget;
            if (typeof window.MeshtasticWidget === 'function') return window.MeshtasticWidget;
            return null;
          }

          function mountOnce() {
            cleanupStaleInstances();

            var Ctor = findCtor();
            if (!Ctor) return false; // not ready yet

            var nodes = document.querySelectorAll('[data-meshtastic-worker]');
            nodes.forEach(function (el) {
              if (el.dataset.meshtasticMounted === '1') return;

              if (!el.id) {
                el.id = 'meshtastic-' + Math.random().toString(36).slice(2);
              }

              var workerUrl = el.getAttribute('data-meshtastic-worker');
              var opts = {};

              if (el.hasAttribute('data-refresh-interval')) {
                opts.refreshInterval = toInt(el.getAttribute('data-refresh-interval'), 60);
              }
              if (el.hasAttribute('data-time-range')) {
                opts.defaultTimeRange = toInt(el.getAttribute('data-time-range'), 24);
              }
              if (el.hasAttribute('data-title')) {
                opts.title = el.getAttribute('data-title');
              }
              if (el.hasAttribute('data-max-nodes')) {
                opts.maxNodes = toInt(el.getAttribute('data-max-nodes'), 20);
              }
              if (el.hasAttribute('data-show-controls')) {
                opts.showControls = el.getAttribute('data-show-controls') !== 'false';
              }
              if (el.hasAttribute('data-auto-refresh')) {
                opts.autoRefresh = el.getAttribute('data-auto-refresh') !== 'false';
              }

              try {
                instances[el.id] = new Ctor(el.id, workerUrl, opts);
                el.dataset.meshtasticMounted = '1';
              } catch (e) {
                console.error('Failed to init MeshtasticWidget for', el, e);
              }
            });

            return true;
          }

          // Retry mounting a few times in case the script is still loading
          function mountWithRetry() {
            var attempts = 0;
            var maxAttempts = 20; // ~2s total
            var timer = setInterval(function () {
              attempts++;
              var ok = mountOnce();
              if (ok || attempts >= maxAttempts) clearInterval(timer);
            }, 100);
          }

          hook.mounted(function () {
            // Run after initial render
            setTimeout(mountWithRetry, 0);
          });
          hook.doneEach(function () {
            // Run after each route navigation
            setTimeout(mountWithRetry, 0);
          });
        }
      ]
    };
  </script>

  <!-- IMPORTANT: load widget BEFORE Docsify so the class exists when hooks run -->
  ./meshtastic-widget.js</script>

  <!-- Docsify core & plugins -->
  https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js</script>
  https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/zoom-image.min.js</script>
  <script src="httpsvr.net/npm/docsify@4/lib/plugins/search.js</script>
</body>
</html>
